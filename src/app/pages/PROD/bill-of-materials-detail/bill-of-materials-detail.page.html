<ion-header>
    <ion-toolbar>
        <ion-buttons slot="start">
            <ion-back-button defaultHref="bill-of-materials"></ion-back-button>
            <ion-button color="dark" class="ion-hide-sm-down">
                Định mức sản xuất
            </ion-button>
        </ion-buttons>
        <ion-buttons slot="end">
            <div *ngIf="pageConfig.canEdit && this.id">
                <ion-button (click)="importClick()" title="Import cấu phần">
                    <ion-icon slot="icon-only" name="cloud-upload-outline"></ion-icon>
                </ion-button>

                <ion-button (click)="addOrderLine({ Type: 'CTItem', IDBOM: item.Id, Id: 0, AdditionalQuantity: 0, IssueMethod: 'Backflush'  })" title="Thêm sản phẩm">
                    <ion-icon slot="icon-only" name="add-circle-outline"></ion-icon>
                </ion-button>
                <span class="split ion-hide-sm-down">|</span>
            </div>
            <ion-button (click)="printBOM()" title="In định mức" *ngIf="pageConfig.canPrint">
                <ion-icon slot="icon-only" name="print"></ion-icon>
            </ion-button>

            <app-detail-toolbar [item]="item" [pageConfig]="pageConfig" (refresh)="refresh()" (delete)="delete()" (help)="help()"></app-detail-toolbar>
        </ion-buttons>
    </ion-toolbar>
</ion-header>

<ion-content appScrollbarTheme class="ion-padding">
    <div id="order-detail-page" style="position: absolute;"></div>
    <form [formGroup]="formGroup">
        <ion-row class="hr-group ion-no-padding caption" *ngIf="env.isMobile">
            <ion-col size="12" size-sm="12" size-md="12" size-xl="12">
                <ion-list-header class="ion-no-padding">
                    <ion-label color="primary">Định mức <span *ngIf="id">#{{id}}</span> </ion-label>
                </ion-list-header>
            </ion-col>
        </ion-row>
        <ion-row class="hr-group ion-no-padding mobile-screen" *ngIf="segmentView.Page == 's2'">
                        
            <ion-col size="12" size-sm="6" size-xl="6">
                
                <div class="c-control">
                    <label class="c-label" for="Quantity">Định mức cho <ion-text color="primary"><b>{{formGroup.controls.Quantity.value}}</b> thành phẩm</ion-text>
                        <span *ngIf="!formGroup.controls.Quantity.valid && !formGroup.controls.Quantity.pending && (formGroup.controls.Quantity.dirty || submitAttempt)" ion-text color="danger">(*)</span>
                    </label>
                    <input [readonly]="!(pageConfig.canEdit || pageConfig.canAdd)" (change)="saveChange()" class="c-input" id="Quantity" formControlName="Quantity" min="1" type="number">
                </div>
                
            </ion-col>
            <ion-col size="12" size-sm="6" size-xl="6">
                <div class="c-control">
                    <label class="c-label" for="BatchSize">Sản lượng / mẻ sản xuất
                        <span *ngIf="!formGroup.controls.BatchSize.valid && !formGroup.controls.BatchSize.pending && (formGroup.controls.BatchSize.dirty || submitAttempt)" ion-text color="danger">(*)</span>
                    </label>
                    <input [readonly]="!(pageConfig.canEdit || pageConfig.canAdd)" (change)="saveChange()" class="c-input" id="BatchSize" formControlName="BatchSize" min="1" type="number">
                </div>
                
            </ion-col>
        </ion-row>
    </form>
    <ion-toolbar *ngIf="env.isMobile" color="primary" class="bomtabs">
        <ion-segment scrollable="true" (ionChange)="segmentChanged($event)" [value]="segmentView.Page">
            <ion-segment-button value="s1">
                <ion-label>Thông tin chung</ion-label>
            </ion-segment-button>
            <ion-segment-button value="s2">
                <ion-label>Định mức sản xuất</ion-label>
            </ion-segment-button>
        </ion-segment>
    </ion-toolbar>
    <div class="main-view" *ngIf="item && pageConfig.showSpinner==false">
        
        
        <div *ngIf="segmentView.Page == 's1'">
            <div [ngClass]="{'row-full shadow full-screen mobile-screen': env.isMobile}">
                <ion-grid fixed>
                    <form [formGroup]="formGroup">
                        <ion-row class="hr-group ion-no-padding">
                            <ion-col [size]="env.isMobile ? 12: 4" *ngIf="!env.isMobile">
                                <ion-list-header class="ion-no-padding">
                                    <ion-label color="primary">Định mức <span *ngIf="id">#{{id}}</span> </ion-label>
                                </ion-list-header>
                                <ion-item class="ion-no-padding" lines="none">
                                    <ion-label color="medium" class="ion-text-wrap">
                                        Để nâng cao bảo mật - bảo vệ tài khoản, bạn nên dùng mật khẩu có:
                                        <ul>
                                            <li>Std Cost: Giá thành định mức</li>
                                            <li>Total Std Cost = <ul>
                                                    <li>[StdCost] * [số lượng] / [số thành phẩm]</li>
                                                    <li>+ </li>
                                                    <li>[StdCost] * ([cộng thêm]/ [số lượng sản xuất])</li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </ion-label>
                                </ion-item>
                            </ion-col>
                            <ion-col [size]="env.isMobile ? 12: 4">
                                <div class="c-control">
                                    <label class="c-label" for="IDItem">Thành phẩm 
                                        <span *ngIf="!formGroup.controls.IDItem.valid && !formGroup.controls.IDItem.pending && (formGroup.controls.IDItem.dirty || submitAttempt)" ion-text color="danger">(*)</span>
                                    </label>
                                    <ng-select class="c-input" (change)="saveChange();" labelForId="IDItem" formControlName="IDItem" [items]="itemList$ | async" [typeahead]="itemListInput$" [virtualScroll]="true" bindLabel="Name" bindValue="Id" placeholder="Tìm tên hoặc mã sản phẩm...">
                                        <ng-template ng-label-tmp let-i="item">
                                            <b *ngIf="i.Code" [title]="i.Id">
                                                {{i.Code}}
                                            </b>
                                            {{i.Name}}
                                        </ng-template>
                                        <ng-template ng-option-tmp let-i="item" let-search="searchTerm">
                                            <div *ngIf="i">
                                                <div><span [ngOptionHighlight]="search">{{i.Name}}</span></div>
                                                <small>#<b><span class="important" [ngOptionHighlight]="search">{{i.Id}} - {{i.Code}}</span></b></small>
                                            </div>
                                        </ng-template>
                                    </ng-select>
                                </div>
                                <div class="c-control">
                                    <label class="c-label" for="Quantity">Định mức cho <ion-text color="primary"><b>{{formGroup.controls.Quantity.value}}</b> thành phẩm</ion-text>
                                        <span *ngIf="!formGroup.controls.Quantity.valid && !formGroup.controls.Quantity.pending && (formGroup.controls.Quantity.dirty || submitAttempt)" ion-text color="danger">(*)</span>
                                    </label>
                                    <input [readonly]="!(pageConfig.canEdit || pageConfig.canAdd)" (change)="saveChange()" class="c-input" id="Quantity" formControlName="Quantity" min="1" type="number">
                                </div>
                                <div class="c-control">
                                    <label class="c-label" for="BatchSize">Sản lượng / mẻ sản xuất
                                        <span *ngIf="!formGroup.controls.BatchSize.valid && !formGroup.controls.BatchSize.pending && (formGroup.controls.BatchSize.dirty || submitAttempt)" ion-text color="danger">(*)</span>
                                    </label>
                                    <input [readonly]="!(pageConfig.canEdit || pageConfig.canAdd)" (change)="saveChange()" class="c-input" id="BatchSize" formControlName="BatchSize" min="1" type="number">
                                </div>
                                
                            </ion-col>
                            
                            <ion-col [size]="env.isMobile ? 12: 4">
                                <div class="c-control">
                                    <label class="c-label" for="Type">Phân loại
                                        <span *ngIf="!formGroup.controls.Type.valid && !formGroup.controls.Type.pending && (formGroup.controls.Type.dirty || submitAttempt)" ion-text color="danger">(*)</span>
                                    </label>
                                    <ng-select class="c-input" (change)="saveChange();" labelForId="Type" formControlName="Type" [items]="typeList" [virtualScroll]="true" bindLabel="Name" bindValue="Code" placeholder="Tìm kiếm...">
                                        <ng-template ng-option-tmp let-i="item" let-search="searchTerm">
                                            <div *ngIf="i">
                                                <div> <span *ngFor="let l of i.levels">&nbsp;&nbsp;&nbsp;</span> <span [ngOptionHighlight]="search">{{i.Name}}</span></div>
                                            </div>
                                        </ng-template>
                                    </ng-select>
                                </div>
                                <div class="c-control" *ngIf="pageConfig.canViewPrice">
                                    <label class="c-label" for="IDPriceList">Bảng giá bán
                                        <span *ngIf="!formGroup.controls.IDPriceList.valid && !formGroup.controls.IDPriceList.pending && (formGroup.controls.IDPriceList.dirty || submitAttempt)" ion-text color="danger">(*)</span>
                                    </label>
                                    <ng-select class="c-input" (change)="changePriceList();" labelForId="IDPriceList" formControlName="IDPriceList" [items]="priceList" bindLabel="Name" bindValue="Id" placeholder="Chọn bảng giá...">
                                        <ng-template ng-option-tmp let-i="item" let-search="searchTerm">
                                            <div *ngIf="i">
                                                <div> <span *ngFor="let l of i.levels">&nbsp;&nbsp;&nbsp;</span> <span [ngOptionHighlight]="search">{{i.Name}}</span></div>
                                            </div>
                                        </ng-template>
                                    </ng-select>
                                </div>
                                <div class="c-control" *ngIf="pageConfig.canViewStdCost">
                                    <label class="c-label" for="IDStdCostPriceList" >Bảng giá định mức
                                        <span *ngIf="!formGroup.controls.IDStdCostPriceList.valid && !formGroup.controls.IDStdCostPriceList.pending && (formGroup.controls.IDStdCostPriceList.dirty || submitAttempt)" ion-text color="danger">(*)</span>
                                    </label>
                                    <ng-select class="c-input" (change)="changePriceList();" labelForId="IDStdCostPriceList" formControlName="IDStdCostPriceList" [items]="priceList" bindLabel="Name" bindValue="Id" placeholder="Chọn bảng giá...">
                                        <ng-template ng-option-tmp let-i="item" let-search="searchTerm">
                                            <div *ngIf="i">
                                                <div> <span *ngFor="let l of i.levels">&nbsp;&nbsp;&nbsp;</span> <span [ngOptionHighlight]="search">{{i.Name}}</span></div>
                                            </div>
                                        </ng-template>
                                    </ng-select>
                                </div>
                            </ion-col>
                        </ion-row>
                    </form>
                </ion-grid>
            </div>
            <div *ngIf="!env.isMobile" class="row-full shadow full-screen" [ngClass]="{'mobile-screen': env.isMobile}">

                    <form [formGroup]="formGroup">
                        <ng-container formArrayName="Lines">
                            <div class="table-contain">
                                <section class="table" style="min-width: 1270px;">
                                    <header class="bold" style="padding-right: 0;">
                                        <div class="col-id cell">#</div>
                                        <div class="col-uom cell">Loại</div>
                                        <div class="col-name cell">Cấu phần</div>
                                        <div class="col-uom cell">Đơn vị</div>
                                        <div class="col-qty cell">Số lượng</div>
                                        <div class="col-qty cell" title="Là một lượng tài nguyên cần để bắt đầu hoặc kết thúc sản xuất.">
                                            Cộng thêm</div>
                                        <div class="col-uom cell">Cấp phát</div>
                                        <div class="col-total cell" *ngIf="pageConfig.canViewPrice"> <small class="clickable"
                                                (click)="resetPrice()" *ngIf="pageConfig.canEditPrice">Reset</small> Price</div>
                                        <div class="col-total cell" *ngIf="pageConfig.canViewPrice">Total price</div>
                                        <div class="col-total cell" *ngIf="pageConfig.canViewStdCost">Std Cost</div>
                                        <div class="col-total cell" *ngIf="pageConfig.canViewStdCost">Total Std Cost</div>
                                        <div class="col-del cell" *ngIf="pageConfig.canEdit"></div>
                                    </header>
                    
                                    <ng-container *ngFor="let g of formGroup.get('Lines')['controls']; let idx = index;">
                    
                                        <ng-container [formGroup]="g">
                                            <div class="row" [ngClass]="{'header': g.controls.Type.value=='CTStage'}">
                                                <div class="col-id cell">{{idx+1}}</div>
                    
                                                <div class="col-uom cell">
                                                    <div class="col-uom cell">
                                                        <select formControlName="Type"
                                                            [attr.disabled]="(!pageConfig.canEdit || submitAttempt)?'':null"
                                                            class="c-input c-dropdown" (change)="changedType(g)">
                                                            <option [disabled]="t.Flag" *ngFor="let t of componentTypeList"
                                                                [value]="t.Code">{{t.Name}}</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <ng-container *ngIf="g.controls.Type.value!='CTItem'">
                                                    <div class="col-remark cell">
                                                        <input formControlName="Name" [readonly]="!pageConfig.canEdit || submitAttempt"
                                                            (change)="saveChange()" class="c-input ion-text-left">
                                                    </div>
                                                </ng-container>
                                                <ng-container *ngIf="g.controls.Type.value=='CTItem'">
                                                    <div class="col-name cell">
                                                        <ng-select formControlName="_Item" appendTo="#order-detail-page"
                                                            [readonly]="!pageConfig.canEdit || submitAttempt" class="c-input"
                                                            (change)="changedIDItem(g, $event)" [labelForId]="'IDItem'+idx"
                                                            [items]="g.controls._ItemDataSource.value | async"
                                                            [typeahead]="g.controls._ItemSearchInput.value"
                                                            [loading]="g.controls._ItemSearchLoading.value" [virtualScroll]="true"
                                                            bindLabel="Name" placeholder="Tìm tên hoặc mã sản phẩm...">
                                                            <ng-template ng-label-tmp let-i="item">
                                                                <b *ngIf="i.Code" [title]="i.Id">
                                                                    {{i.Code}}
                                                                </b>
                                                                {{i.Name}}
                                                            </ng-template>
                                                            <ng-template ng-option-tmp let-i="item" let-search="searchTerm">
                                                                <div *ngIf="i">
                                                                    <div><span [ngOptionHighlight]="search">{{i.Name}}</span></div>
                                                                    <small>#<b><span class="important" [ngOptionHighlight]="search">{{i.Id}}
                                                                                - {{i.Code}}</span></b></small>
                                                                </div>
                                                            </ng-template>
                                                        </ng-select>
                                                    </div>
                                                    <div class="col-uom cell">
                                                        <select formControlName="IDUoM"
                                                            [attr.disabled]="(!pageConfig.canEdit || submitAttempt)?'':null"
                                                            class="c-input c-dropdown" (change)="changedIDUoM(g)">
                                                            <option [disabled]="t.Flag" *ngFor="let t of g.controls._UoMs.value"
                                                                [value]="t.Id">{{t.Name}}</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-qty cell">
                                                        <input formControlName="Quantity" [readonly]="!pageConfig.canEdit || submitAttempt"
                                                            (focus)="$event.target.select()" (change)="saveChange()" class="c-input"
                                                            type="number" [min]="1" [max]="99999" onkeydown="return event.keyCode !== 190">
                                                    </div>
                                                    <div class="col-qty cell">
                                                        <input formControlName="AdditionalQuantity"
                                                            [readonly]="!pageConfig.canEdit || submitAttempt"
                                                            (focus)="$event.target.select()" (change)="saveChange()" class="c-input"
                                                            type="number" [min]="0" [max]="99999" onkeydown="return event.keyCode !== 190">
                                                    </div>
                                                    <div class="col-uom cell">
                                                        <select formControlName="IssueMethod"
                                                            [attr.disabled]="(!pageConfig.canEdit || submitAttempt)?'':null"
                                                            class="c-input c-dropdown" (change)="saveChange()">
                                                            <option [disabled]="t.Flag" *ngFor="let t of issueMethodList" [value]="t.Code">
                                                                {{t.Name}}</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-total cell" *ngIf="pageConfig.canViewPrice">
                                                        <input formControlName="UoMPrice" class="c-input"
                                                            [readonly]="!(pageConfig.canEdit && pageConfig.canEditPrice)"
                                                            (focus)="$event.target.select()" (change)="saveChange()" mask="separator.0"
                                                            thousandSeparator="," [allowNegativeNumbers]="false">
                                                    </div>
                                                    <div class="col-total cell disable" *ngIf="pageConfig.canViewPrice">{{
                                                        (g.controls.TotalPrice.value ) | mask: 'separator.0':','}}</div>
                                                    <div class="col-total cell disable" *ngIf="pageConfig.canViewStdCost">{{
                                                        g.controls.StdCost.value | mask: 'separator.0':','}}</div>
                                                    <div class="col-total cell disable" *ngIf="pageConfig.canViewStdCost">{{
                                                        (g.controls.TotalStdCost.value ) | mask: 'separator.0':','}}</div>
                                                </ng-container>
                                                <div class="col-del cell" *ngIf="pageConfig.canEdit" (click)="removeOrderLine(idx, true)">
                                                    <ion-icon color="danger" class="min-btn" name="trash-outline"></ion-icon>
                                                </div>
                                            </div>
                    
                                        </ng-container>
                                    </ng-container>
                                    <div class="row" *ngIf="pageConfig.canEdit && item?.Lines?.length > 1">
                                        <div class="col-id cell" *ngIf="pageConfig.canEdit"
                                            (click)="addOrderLine({ Type: 'CTItem', IDBOM: item.Id, Id: 0, AdditionalQuantity: 0, IssueMethod: 'Backflush'  })">
                                            <ion-icon class="min-btn" title="Thêm sản phẩm" name="add-circle-outline"></ion-icon>
                                        </div>
                                        <div class="col-id cell" *ngIf="!pageConfig.canEdit"></div>
                                        <div class="col-remark cell">
                                            <div class="col-remark cell">
                                                <b *ngIf="pageConfig.canEdit && this.id"
                                                    (click)="addOrderLine({ Type: 'CTItem', IDBOM: item.Id, Id: 0, AdditionalQuantity: 0, IssueMethod: 'Backflush'  })">Thêm
                                                    cấu phần</b>
                                            </div>
                                        </div>
                                        <div class="col-uom cell">
                                            <div style="height: 35px;"></div>
                                        </div>
                                        <div class="col-total cell"><b>Tổng cộng:</b></div>
                                        <div class="col-total cell disable" *ngIf="pageConfig.canViewPrice"><b>{{ item.TotalPrice | mask:
                                                'separator.0':',' }}</b></div>
                                        <div class="col-total cell disable" *ngIf="pageConfig.canViewStdCost"><b></b></div>
                                        <div class="col-total cell disable" *ngIf="pageConfig.canViewStdCost"><b>{{ item.TotalStdCost |
                                                mask: 'separator.0':',' }}</b></div>
                                        <div class="col-del cell disable" *ngIf="pageConfig.canEdit"></div>
                                    </div>
                                </section>
                            </div>
                    
                            
                        </ng-container>
                    </form>
        
                    <div class="table-contain">
                        <div class="row" *ngIf="pageConfig.canEdit && this.id && item?.Lines?.length < 2">
                            <div class="cell">
                                <ion-button fill="clear" size="small"
                                    (click)="addOrderLine({ Type: 'CTItem', IDBOM: item.Id, Id: 0, AdditionalQuantity: 0, IssueMethod: 'Backflush'  })">
                                    <ion-icon slot="start" name="add-circle"></ion-icon>
                                    Thêm cấu phần
                                </ion-button>
                            </div>
                        </div>
                    </div>
                
                
            </div>
        </div>
        <div *ngIf="segmentView.Page == 's2'">
            <div class="row-full shadow full-screen" [ngClass]="{'mobile-screen': env.isMobile}">
                <form [formGroup]="formGroup">
                    <ng-container formArrayName="Lines">
                        <!-- mobile version -->
                        <div *ngIf="env.isMobile" style="min-height: calc(100vh - 410px);">
                    
                            <ion-card class="bom-details ion-no-margin">
                                <ng-container *ngFor="let g of formGroup.get('Lines')['controls']; let idx = index;">
                
                                    <ng-container [formGroup]="g">
                                        <ion-card-content class="info barcode"
                                            [ngClass]="{'ctheader': g.controls.Type.value=='CTStage'}">
                                            <ng-container *ngIf="g.controls.Type.value!='CTItem'">
                                                <div
                                                    [ngClass]="{'ct-other': g.controls.Type.value!='CTStage', 'ct-stage': g.controls.Type.value=='CTStage'}">
                                                    <div class="ct-del-item" *ngIf="pageConfig.canEdit" (click)="removeOrderLine(idx, false)">
                                                        <ion-icon color="danger" class="min-btn" name="trash-outline"></ion-icon>
                                                    </div>
                                                    <select formControlName="Type" class="c-dropdown" (change)="changedType(g)">
                                                        <option [disabled]="t.Flag" *ngFor="let t of componentTypeList"
                                                            [value]="t.Code">{{t.Name}}</option>
                                                    </select>
                                                    <input *ngIf="g.controls.Type.value=='CTStage'" formControlName="Name"
                                                        [readonly]="!pageConfig.canEdit || submitAttempt || item.Status=='Palletized'"
                                                        class="c-input ion-text-left">
                                                    <ion-textarea *ngIf="g.controls.Type.value!='CTStage'" formControlName="Name"
                                                        [readonly]="!pageConfig.canEdit || submitAttempt || item.Status=='Palletized'"
                                                        class="c-text-area ion-text-left"></ion-textarea>
                                                </div>
                                            </ng-container>
                                            <ng-container *ngIf="g.controls.Type.value=='CTItem'">
                                                <div class="ct-item">
                                                    <div class="ct-del-item" *ngIf="pageConfig.canEdit" (click)="removeOrderLine(idx, false)">
                                                        <ion-icon color="danger" class="min-btn" name="trash-outline"></ion-icon>
                                                    </div>
                                                    <select formControlName="Type" class="c-input c-dropdown" (change)="changedType(g)">
                                                        <option [disabled]="t.Flag" *ngFor="let t of componentTypeList"
                                                            [value]="t.Code">{{t.Name}}</option>
                                                    </select>
                                                    <br>
                                                    <ng-select formControlName="_Item" appendTo="#order-detail-page"
                                                        [readonly]="!pageConfig.canEdit || submitAttempt || item.Status=='Palletized'"
                                                        class="c-input" (change)="changedIDItem(g, $event)" [labelForId]="'IDItem'+idx"
                                                        [items]="g.controls._ItemDataSource.value | async"
                                                        [typeahead]="g.controls._ItemSearchInput.value"
                                                        [loading]="g.controls._ItemSearchLoading.value" [virtualScroll]="true"
                                                        bindLabel="Name" placeholder="Tìm tên hoặc mã sản phẩm...">
                                                        <ng-template ng-label-tmp let-i="item">
                                                            <b *ngIf="i.Code" [title]="i.Id">
                                                                {{i.Code}}
                                                            </b>
                                                            {{i.Name}}
                                                        </ng-template>
                                                        <ng-template ng-option-tmp let-i="item" let-search="searchTerm">
                                                            <div *ngIf="i">
                                                                <div><span [ngOptionHighlight]="search">{{i.Name}}</span></div>
                                                                <small>#<b><span class="important" [ngOptionHighlight]="search">{{i.Id}}
                                                                            - {{i.Code}}</span></b></small>
                                                            </div>
                                                        </ng-template>
                                                    </ng-select>
                
                                                </div>
                
                                                <div slot="start" class="c-quantity">
                                                    <ion-badge class="ion-text-lowercase" slot="start">
                                                        <input formControlName="Quantity" (focus)="$event.target.select()"
                                                            [readonly]="!pageConfig.canEdit || submitAttempt"
                                                            [disabled]="!pageConfig.canEdit" class="txtQtyInput" type="number"
                                                            [ngModel]="g.controls.Quantity.value" (ionChange)="this.calcTotalLine()">
                
                                                        <select formControlName="IDUoM"
                                                            [attr.disabled]="(!pageConfig.canEdit || submitAttempt)?'':null"
                                                            class="c-input c-dropdown" (change)="changedIDUoM(g)">
                                                            <option [disabled]="t.Flag" *ngFor="let t of g.controls._UoMs.value"
                                                                [value]="t.Id">{{t.Name}}</option>
                                                        </select>
                
                                                        <!-- <ion-text>{{g.controls.Quantity.value}} </ion-text> -->
                                                    </ion-badge>
                                                    <ion-range formControlName="Quantity" (click)="g.txtQtyShow = !g.txtQtyShow"
                                                        (ionChange)="this.calcTotalLine()" [ngModel]="g.controls.Quantity.value"
                                                        [disabled]="!pageConfig.canEdit" debounce="300" min="0" max="1000"
                                                        color="success" pin="true" step="1" [snaps]="false">
                                                    </ion-range>
                                                    <div class="ct-additional-quantity">
                                                        <input formControlName="AdditionalQuantity" (change)="this.calcTotalLine()"
                                                            [ngModel]="g.controls.AdditionalQuantity.value"
                                                            [readonly]="!pageConfig.canEdit || submitAttempt || item.Status=='Palletized'"
                                                            (focus)="$event.target.select()" class="c-input txtAddQtyInput"
                                                            type="number" [min]="0" [max]="99999"
                                                            onkeydown="return event.keyCode !== 190">
                                                        <ion-text>±</ion-text>
                                                        <ion-range formControlName="AdditionalQuantity"
                                                            (click)="g.txtAddQtyShow = !g.txtAddQtyShow"
                                                            (ionChange)="this.calcTotalLine()"
                                                            [ngModel]="g.controls.AdditionalQuantity.value"
                                                            [disabled]="!pageConfig.canEdit" debounce="300" min="0" max="100"
                                                            color="success" pin="true" step="1" [snaps]="false">
                                                        </ion-range>
                                                    </div>
                
                
                                                </div>
                                                <div *ngIf="pageConfig.canEditPrice">
                                                    <ion-text class="btnShowPrice" (click)="togglePrice(idx)" [ngClass]="{'showned' : isShowPrice[idx]}">Xem giá</ion-text>
                                                </div>
                                                <div class="additional-info" *ngIf="isShowPrice[idx]" [ngClass]="{'hidden-field' : !pageConfig.canEditPrice}">
                                                    <table class="table">
                                                        <tr>
                                                            <td>
                                                                Đơn giá bán
                                                            </td>
                
                                                            <td  class="align-right">
                                                                <input formControlName="UoMPrice" [ngModel]="g.controls.UoMPrice.value"
                                                                class="c-input"
                                                                [readonly]="!(pageConfig.canEdit && pageConfig.canEditPrice)"
                                                                (focus)="$event.target.select()" (change)="this.calcTotalLine()"
                                                                mask="separator.0" thousandSeparator=","
                                                                [allowNegativeNumbers]="false"> đ
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                Giá bán đề xuất    
                                                            </td>
                
                                                            <td class="align-right">
                                                                <b> {{ (g.controls.TotalPrice.value ) | mask: 'separator.0':','}} đ</b>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                Đơn giá sản xuất
                                                            </td>
                
                                                            <td class="align-right">
                                                                {{ (g.controls.StdCost.value ) | mask: 'separator.0':','}} đ
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                Giá thành sản xuất
                                                            </td>
                
                                                            <td class="align-right">
                                                                <b>{{ (g.controls.TotalStdCost.value ) | mask: 'separator.0':','}} đ</b>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                
                                            </ng-container>
                                        </ion-card-content>
                                    </ng-container>
                                </ng-container>
                
                                <div class="btn-add-new" *ngIf="pageConfig.canEdit">
                                    <div class="btnAddNewContainer" *ngIf="pageConfig.canEdit">
                                        <ion-icon class="min-btn" title="Thêm sản phẩm" name="add-circle-outline"></ion-icon>
                                        <b class="btnAdd" *ngIf="pageConfig.canEdit && this.id"
                                            (click)="addOrderLine({ Type: 'CTItem', IDBOM: item.Id, Id: 0, AdditionalQuantity: 0, IssueMethod: 'Backflush'  })">Thêm
                                            cấu phần</b>
                                    </div>
                                </div>
                
                                <ion-card-content class="info barcode secondary total-price" *ngIf="pageConfig.canEdit">
                
                                    <div>
                                        <ion-badge class="ion-float-right">
                                            {{ item.TotalPrice | mask: 'separator.0':',' }} đ</ion-badge>
                                        <ion-badge color="secondary">GIÁ BÁN ĐỀ XUẤT</ion-badge>
                                    </div>
                
                                    <div>
                                        <ion-badge class="ion-float-right">
                                            {{ item.TotalStdCost | mask: 'separator.0':',' }} đ</ion-badge>
                                        <ion-badge color="secondary">GIÁ THÀNH SẢN XUẤT</ion-badge>
                                    </div>
                
                                </ion-card-content>
                
                                <div class="btn-save" *ngIf="pageConfig.canEdit">
                                    <div class="btnSaveContainer" *ngIf="pageConfig.canEdit">
                                        <!-- <ion-icon class="min-btn" title="Lưu lại các điều chỉnh" name="save-outline"></ion-icon> -->
                                        <b class="btnSave" *ngIf="pageConfig.canEdit" (click)="saveAll()">Lưu lại</b>
                                    </div>
                                </div>
                
                            </ion-card>
                
                
                        </div>
                    </ng-container>
                </form>
            </div>
        </div>
    </div>
    <app-page-message [itemsLength]="item? 1: 0" [showSpinner]="pageConfig.showSpinner"></app-page-message>
</ion-content>